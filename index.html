<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Queries de Ratificación v2</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Generador de Queries de Ratificación v2</h1>
            <p>Automatización completa del proceso de cuadre DDV vs EDV</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('parametros')">1. Parámetros</div>
            <div class="tab" onclick="switchTab('describe')">2. Describe Tabla</div>
            <div class="tab" onclick="switchTab('queries')">3. Queries Generados</div>
            <div class="tab" onclick="switchTab('repositorio')">4. Repositorio</div>
            <div class="tab" onclick="switchTab('export')">5. Exportar Excel</div>
        </div>
        
        <!-- TAB 1: PARÁMETROS -->
        <div id="parametros" class="tab-content active">
            <h3>Configuración de Esquemas y Tablas</h3>
            
            <div class="row">
                <div class="form-group">
                    <label>Esquema DDV (Producción)</label>
                    <input type="text" id="esquemaDDV" placeholder="catalog_lhcl_prod_bcp.bcp_ddv_matrizvariables_v">
                </div>
                <div class="form-group">
                    <label>Tabla DDV</label>
                    <input type="text" id="tablaDDV" placeholder="hm_matrizdemografico">
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label>Esquema EDV (Desarrollo)</label>
                    <input type="text" id="esquemaEDV" placeholder="catalog_lhcl_prod_bcp_expl.bcp_edv_trdata_012">
                </div>
                <div class="form-group">
                    <label>Tabla EDV</label>
                    <input type="text" id="tablaEDV" placeholder="hm_matrizdemografico_ruben">
                </div>
            </div>
            
            <div class="form-group">
                <label>Períodos a evaluar (separados por coma)</label>
                <input type="text" id="periodos" placeholder="202505, 202506, 202507" value="202505, 202506, 202507">
            </div>
            
            <div class="form-group">
                <label>Reglas de renombrado para EDV (formato: original:nuevo)</label>
                <textarea id="renameRules" placeholder="codclaveunicocli:cod_uni_cocli&#10;otrocampo:otro_campo_nuevo">codclaveunicocli:cod_uni_cocli</textarea>
            </div>
            
            <button class="btn" onclick="saveParameters()">Guardar Parámetros</button>
        </div>
        
        <!-- TAB 2: DESCRIBE TABLA -->
        <div id="describe" class="tab-content">
            <h3>Estructura de la Tabla</h3>
            
            <div class="row">
                <div class="form-group">
                    <label>Seleccionar tabla del repositorio</label>
                    <select id="tableSelector" onchange="loadTableFromRepo()">
                        <option value="">-- Seleccionar tabla existente --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Buscar tabla</label>
                    <input type="text" id="tableSearch" placeholder="Buscar por nombre..." oninput="filterTables()">
                </div>
            </div>
            
            <div class="form-group">
                <label>CREATE TABLE Statement</label>
                <textarea id="createTableInput" placeholder="Pega aquí tu CREATE TABLE o selecciona una tabla del repositorio..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn" onclick="parseCreateTable()">Analizar Estructura</button>
                <button class="btn btn-secondary" onclick="saveToRepository()">Guardar en Repositorio</button>
                <button class="btn btn-secondary" onclick="showRepositoryManager()">Gestionar Repositorio</button>
            </div>
            
            <div id="fieldMapping" style="display: none;">
                <h4>Campos Detectados y Mapeo</h4>
                <div class="field-mapping">
                    <div class="field-row">
                        <div class="field-header">Campo Original</div>
                        <div class="field-header">Tipo de Dato</div>
                        <div class="field-header">Función</div>
                        <div class="field-header">EDV</div>
                    </div>
                    <div id="fieldMappingContent"></div>
                </div>
                
                <div class="stats" id="statsSection"></div>
            </div>
        </div>
        
        <!-- TAB 3: QUERIES GENERADOS -->
        <div id="queries" class="tab-content">
            <h3>Queries de Ratificación</h3>
            
            <button class="btn btn-success" onclick="generateAllQueries()">Generar Todos los Queries</button>
            
            <div id="queryOutputs"></div>
        </div>
        
        <!-- TAB 4: REPOSITORIO -->
        <div id="repositorio" class="tab-content">
            <h3>Repositorio de CREATE TABLEs</h3>
            
            <div class="stats" id="repoStats"></div>
            
            <div class="row">
                <div class="form-group">
                    <label>Filtrar por esquema</label>
                    <select id="schemaFilter" onchange="filterRepository()">
                        <option value="">Todos los esquemas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Buscar tabla</label>
                    <input type="text" id="repoSearch" placeholder="Buscar tabla..." oninput="filterRepository()">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="importFromFile()">Importar CREATE TABLEs</button>
                <button class="btn btn-secondary" onclick="exportRepository()">Exportar Repositorio</button>
                <button class="btn btn-secondary" onclick="clearRepository()">Limpiar Todo</button>
            </div>
            
            <div id="repositoryList"></div>
            
            <input type="file" id="fileImport" style="display: none" accept=".sql,.txt" onchange="handleFileImport(event)">
        </div>
        
        <!-- TAB 5: EXPORTAR EXCEL -->
        <div id="export" class="tab-content">
            <h3>Exportar a Excel</h3>
            
            <div class="form-group">
                <label>Formato de Excel</label>
                <select id="excelFormat">
                    <option value="standard">Formato Estándar</option>
                    <option value="cuadre">Formato Cuadre (como template original)</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="exportToExcel()">Generar Excel</button>
            
            <div id="exportPreview"></div>
        </div>
    </div>

    <!-- Modal para vista completa -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalContent" style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
</body>
</html>