<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Queries de Ratificaci√≥n v2</title>
    <!-- CSS Modular para mejor mantenimiento -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/modules.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Generador de Queries de Ratificaci√≥n v2</h1>
            <p>Automatizaci√≥n completa del proceso de cuadre DDV vs EDV</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('parametros')">1. Par√°metros</div>
            <div class="tab" onclick="switchTab('describe')">2. Describe Tabla</div>
            <div class="tab" onclick="switchTab('queries')">3. Queries Generados</div>
            <div class="tab" onclick="switchTab('repositorio')">4. Repositorio</div>
            <div class="tab" onclick="switchTab('export')">5. Exportar Excel</div>
        </div>
        
        <!-- TAB 1: PAR√ÅMETROS -->
        <div id="parametros" class="tab-content active">
            <h3>Configuraci√≥n de Esquemas y Tablas</h3>
            
            <div class="row">
                <div class="form-group">
                    <label>Esquema DDV (Producci√≥n)</label>
                    <input type="text" id="esquemaDDV" placeholder="catalog_lhcl_prod_bcp.bcp_ddv_matrizvariables_v">
                </div>
                <div class="form-group">
                    <label>Tabla DDV</label>
                    <input type="text" id="tablaDDV" placeholder="hm_matrizdemografico">
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label>Esquema EDV (Desarrollo)</label>
                    <input type="text" id="esquemaEDV" placeholder="catalog_lhcl_prod_bcp_expl.bcp_edv_trdata_012">
                </div>
                <div class="form-group">
                    <label>Tabla EDV</label>
                    <input type="text" id="tablaEDV" placeholder="hm_matrizdemografico_ruben">
                </div>
            </div>
            
            <div class="form-group">
                <label>Per√≠odos a evaluar (separados por coma)</label>
                <input type="text" id="periodos" placeholder="202505, 202506, 202507" value="202505, 202506, 202507">
            </div>
            
            <div class="form-group">
                <label>Reglas de renombrado para EDV (formato: original:nuevo)</label>
                <textarea id="renameRules" placeholder="codclaveunicocli:cod_uni_cocli&#10;otrocampo:otro_campo_nuevo">codclaveunicocli:cod_uni_cocli</textarea>
            </div>
            
            <button class="btn" onclick="ParametersModule.saveParameters()">Guardar Par√°metros</button>
        </div>
        
        <!-- TAB 2: DESCRIBE TABLA -->
        <div id="describe" class="tab-content">
            <h3>Estructura de la Tabla</h3>
            
            <div class="row">
                <div class="form-group">
                    <label>Seleccionar tabla del repositorio</label>
                    <select id="tableSelector" onchange="RepositoryModule.loadTableFromRepo()">
                        <option value="">-- Seleccionar tabla existente --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Buscar tabla</label>
                    <input type="text" id="tableSearch" placeholder="Buscar por nombre..." oninput="RepositoryModule.filterTables()">
                </div>
            </div>
            
            <div class="form-group">
                <label>CREATE TABLE Statement o Query Completa</label>
                <textarea id="createTableInput" placeholder="Pega aqu√≠ tu CREATE TABLE, query completa, o cualquier texto que contenga un CREATE TABLE..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="TableAnalysisModule.detectCreateTable()" style="background: #28a745;">üîç Detectar CREATE TABLE</button>
                <button class="btn" onclick="TableAnalysisModule.parseCreateTable()">Analizar Estructura</button>
                <button class="btn btn-secondary" onclick="RepositoryModule.saveToRepository()">Guardar en Repositorio</button>
                <button class="btn btn-secondary" onclick="RepositoryModule.showRepositoryManager()">Gestionar Repositorio</button>
            </div>
            
            <div class="form-group">
                <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">
                    üí° <strong>Tip:</strong> Puedes pegar cualquier texto que contenga un CREATE TABLE (queries, archivos SQL, documentaci√≥n, etc.) 
                    y usar "Detectar CREATE TABLE" para extraerlo autom√°ticamente.
                </p>
            </div>
            
            <div id="fieldMapping" style="display: none;">
                <h4>Campos Detectados y Mapeo</h4>
                <div class="field-mapping">
                    <div class="field-row">
                        <div class="field-header">Campo Original</div>
                        <div class="field-header">Tipo de Dato</div>
                        <div class="field-header">Funci√≥n</div>
                        <div class="field-header">EDV</div>
                    </div>
                    <div id="fieldMappingContent"></div>
                </div>
                
                <div class="stats" id="statsSection"></div>
            </div>
        </div>
        
        <!-- TAB 3: QUERIES GENERADOS -->
        <div id="queries" class="tab-content">
            <h3>Queries de Ratificaci√≥n</h3>
            
            <div class="queries-header">
                <button class="btn btn-success" onclick="QueryModule.generateAllQueries()">‚ö° Generar Todos los Queries</button>
                
                <div class="quick-export" id="quickExportButtons" style="display: none;">
                    <h4>üì• Export R√°pido</h4>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="ExportModule.exportQueries('sql')" title="Descargar todos los queries en formato SQL">
                            üìÑ .SQL
                        </button>
                        <button class="btn btn-secondary" onclick="ExportModule.exportQueries('txt')" title="Descargar reporte completo en texto">
                            üìù .TXT
                        </button>
                        <button class="btn btn-secondary" onclick="ExportModule.exportQueriesExcel()" title="Descargar Excel solo con queries">
                            üìä .XLSX
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="queryOutputs"></div>
        </div>
        
        <!-- TAB 4: REPOSITORIO -->
        <div id="repositorio" class="tab-content">
            <h3>Repositorio de CREATE TABLEs</h3>
            
            <div class="stats" id="repoStats"></div>
            
            <div class="row">
                <div class="form-group">
                    <label>Filtrar por esquema</label>
                    <select id="schemaFilter" onchange="RepositoryModule.filterRepository()">
                        <option value="">Todos los esquemas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Filtrar por tabla</label>
                    <select id="tableFilter" onchange="RepositoryModule.filterRepository()">
                        <option value="">Todas las tablas</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label>Buscar tabla</label>
                    <input type="text" id="repoSearch" placeholder="Buscar tabla..." oninput="RepositoryModule.filterRepository()">
                </div>
                <div class="form-group">
                    <label>Mostrar</label>
                    <select id="showFilter" onchange="RepositoryModule.filterRepository()">
                        <option value="all">Todas las tablas</option>
                        <option value="ddv">Solo DDV</option>
                        <option value="edv">Solo EDV</option>
                        <option value="recent">Agregadas recientemente</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="RepositoryModule.importFromFile()">üìÅ Importar Archivo .sql/.txt</button>
                <button class="btn btn-secondary" onclick="RepositoryModule.exportRepository()">üì§ Exportar Repositorio</button>
                <button class="btn btn-secondary" onclick="RepositoryModule.clearRepository()">üóëÔ∏è Limpiar Todo</button>
            </div>
            
            <div class="form-group">
                <p style="color: #6c757d; font-size: 14px;">
                    üí° <strong>Funcionalidades del repositorio:</strong><br>
                    ‚Ä¢ <strong>Detecci√≥n autom√°tica:</strong> Al pegar texto, detecta CREATE TABLEs autom√°ticamente<br>
                    ‚Ä¢ <strong>Auto-completado:</strong> Sugiere esquemas DDV/EDV basado en patrones<br>
                    ‚Ä¢ <strong>Importaci√≥n masiva:</strong> Sube archivos .sql con m√∫ltiples CREATE TABLEs<br>
                    ‚Ä¢ <strong>Persistencia:</strong> Guarda todo en tu navegador para uso futuro
                </p>
            </div>
            
            <div id="repositoryList"></div>
            
            <input type="file" id="fileImport" style="display: none" accept=".sql,.txt" onchange="RepositoryModule.handleFileImport(event)">
        </div>
        
        <!-- TAB 5: EXPORTAR EXCEL -->
        <div id="export" class="tab-content">
            <h3>Exportar Resultados</h3>
            
            <!-- SECCI√ìN TEMPLATE UPLOAD (NUEVA) -->
            <div class="export-section">
                <h4>üìÇ Template Personalizado</h4>
                <p>Carga tu template Excel para mantener formato y estructura espec√≠fica</p>
                
                <div class="export-buttons">
                    <button class="btn" onclick="ExportModule.loadTemplate()">üìÇ Cargar Template</button>
                </div>
                
                <div id="templateInfo" style="margin-top: 10px;"></div>
            </div>

            <!-- Secci√≥n Excel Cuadre EDV V3 -->
            <div class="export-section">
                <h4>üìä Excel Cuadre EDV (V3)</h4>
                <p>Formato espec√≠fico para cuadre con 3 pesta√±as: Universo, Agrupado, Minus</p>
                
                <button class="btn btn-success" onclick="ExportModule.exportCuadreEDV()" 
                        title="Excel espec√≠fico para cuadre EDV con 3 pesta√±as">
                    üìä GENERAR EXCEL CUADRE EDV
                </button>
            </div>
            
            <!-- Secci√≥n Solo Queries -->
            <div class="export-section">
                <h4>üîç Export Solo Queries</h4>
                <p>Archivos ligeros con √∫nicamente los queries de ratificaci√≥n</p>
                
                <div class="export-buttons">
                    <button class="btn" onclick="ExportModule.exportQueries('sql')" title="Archivo SQL ejecutable">
                        üìÑ Descargar .SQL
                    </button>
                    <button class="btn" onclick="ExportModule.exportQueries('txt')" title="Archivo de texto con informaci√≥n completa">
                        üìù Descargar .TXT
                    </button>
                    <button class="btn" onclick="ExportModule.exportQueriesExcel()" title="Excel solo con queries">
                        üìä Descargar .XLSX (Solo Queries)
                    </button>
                    <button class="btn btn-warning" onclick="ExportModule.exportAllQueriesTXT()" title="Todos los queries en un archivo TXT">
                        üìã TODOS LOS QUERIES (.TXT)
                    </button>
                </div>
            </div>
            
            <!-- Secci√≥n Excel Completo Original -->
            <div class="export-section">
                <h4>üìã Excel Completo (Formato Original)</h4>
                <p>Incluye par√°metros, estructura de tabla, queries y metadatos</p>
                
                <div class="form-group">
                    <label>Formato de Excel</label>
                    <select id="excelFormat">
                        <option value="standard">Formato Est√°ndar</option>
                        <option value="cuadre">Formato Cuadre (como template original)</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="ExportModule.exportToExcel()">
                    üìã Generar Excel Completo
                </button>
            </div>
            
            <div id="exportPreview"></div>
        </div>
    </div>

    <!-- Modal para vista completa -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="UIModule.closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalContent" style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Scripts modulares -->
    <script src="js/utils.js"></script>
    <script src="js/regex-patterns.js"></script>
    <script src="js/table-analysis.js"></script>
    <script src="js/parameters.js"></script>
    <script src="js/repository.js"></script>
    <script src="js/query-generator.js"></script>
    <script src="js/export.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
</body>
</html>